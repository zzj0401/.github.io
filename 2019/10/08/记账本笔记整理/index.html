<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  
  <title>记账本笔记整理 - 日行千里</title>
  <meta charset="UTF-8">
  <meta name="description" content="程序猿日常">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  

  <link rel="shortcut icon" href="/favicon.ico" type="image/png">
  <meta name="description" content="记账本笔记整理">
<meta property="og:type" content="article">
<meta property="og:title" content="记账本笔记整理">
<meta property="og:url" content="http://yoursite.com/2019/10/08/记账本笔记整理/index.html">
<meta property="og:site_name" content="日行千里">
<meta property="og:description" content="记账本笔记整理">
<meta property="og:locale" content="zh-tw">
<meta property="og:updated_time" content="2019-10-14T02:39:27.925Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="记账本笔记整理">
<meta name="twitter:description" content="记账本笔记整理">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/atom-one-dark.css">
   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
  <link rel="stylesheet" href="../../../../css/style.css?v=1572060641378">
</head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(http://b-ssl.duitang.com/uploads/item/201708/24/20170824232705_Y2x58.jpeg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="../../../../index.html" title="shuo" class="mdui-btn mdui-btn-icon"><img src="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=2003571102,4002116936&amp;fm=26&amp;gp=0.jpg"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="../../../../index.html" title="shuo">
            <img src="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=2003571102,4002116936&amp;fm=26&amp;gp=0.jpg" alt="shuo">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>Articles</span>19</div>
        <div><span>Tags</span>0</div>
        <div><span>Categories</span>0</div>
    </div>
    <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="../../../../index.html" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="../../../../about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="../../../../PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </ul>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Social</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://space.bilibili.com/20238211" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/zzj0401/zzj0401.github.io" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
  
  

  
  
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Archive</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2019/08/">八月 2019</a></li></ul>
    </div>
  </div>


  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2019 shuo
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    <div class="nexmoe-post-cover"> 
        
        <img src="http://img1.imgtn.bdimg.com/it/u=1094882081,1355219468&fm=26&gp=0.jpg">
        
        <h1>记账本笔记整理</h1>
    </div>
  <div class="nexmoe-post-meta">
    <a><i class="nexmoefont icon-calendar-fill"></i>2019年10月08日</a>
    <a><i class="nexmoefont icon-areachart"></i>3.8k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 20 分钟</a>
    
    
  </div>
  <article>
    <h1 id="记账本笔记整理"><a href="#记账本笔记整理" class="headerlink" title="记账本笔记整理"></a>记账本笔记整理</h1><a id="more"></a>

<h2 id="一-项目需求"><a href="#一-项目需求" class="headerlink" title="一.项目需求"></a>一.项目需求</h2><p>一个可以根据月份统计支出收入的记账本，可以增删改查</p>
<p>1.运用框架:react</p>
<p>2.样式：bootstrap</p>
<p>在react中使用bootstrap可以直接在index.html引入bootstrap文件</p>
<pre><code>&lt;script src=&quot;https://code.jquery.com/jquery-3.3.1.slim.min.js&quot; integrity=&quot;sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js&quot; integrity=&quot;sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
      &lt;script src=&quot;https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js&quot; integrity=&quot;sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
      &lt;link rel=&quot;stylesheet&quot; href=&quot;https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css&quot; integrity=&quot;sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO&quot; crossorigin=&quot;anonymous&quot;&gt;
</code></pre><p>在bootstrap中使用flex布局：</p>
<pre><code>&lt;div className=&quot;d-flex justify-content-between align-items-center&quot;&gt;&lt;/div&gt;</code></pre><p>其中：justify-content是项目水平布局，align-items-center是项目垂直布局居中。</p>
<p>3.图标库：react-ionicons</p>
<p>关于Ionicons，可以参考：<a href="http://ionicons.com/" target="_blank" rel="noopener">http://ionicons.com/</a></p>
<p>另外补充图标的知识：svg与font icon</p>
<p>svg是可以使用css控制，font icon 只可以用字符的样式</p>
<p>4.数据类型控制：PropTypes</p>
<pre><code>PriceList.propTypes = {

  items:PropTypes.array.isRequired,

  onModifyItem:PropTypes.func.isRequired,

  onDeleteItem:PropTypes.func.isRequired,

}</code></pre><p>5.图表：react charts library(Recharts)</p>
<h2 id="二-一些处理"><a href="#二-一些处理" class="headerlink" title="二.一些处理"></a>二.一些处理</h2><p>1.添加默认props,当没有props时使用默认props:</p>
<pre><code>PriceList.defaultProps={

  onModifyItem:()=&gt;{}

}</code></pre><p>2.可以把字符串一些常量放在某个文件中进行引用</p>
<p>3.对于根据不同条件显示不同内容可以使用：{isOpen&amp;&amp;要执行的代码}（类似if或?:的判断语句）</p>
<p>isOpen是判断条件</p>
<p>4.在事件中可以添加event.preventDefault()来阻止冒泡事件</p>
<p>5.react中若有多个节点，可以用</p>
<pre><code>&lt;React.Fragment&gt;&lt;/React.Fragment&gt;</code></pre><p>来包裹。</p>
<h2 id="三-日期处理"><a href="#三-日期处理" class="headerlink" title="三.日期处理"></a>三.日期处理</h2><p>1.将传入的日期字符串格式化：</p>
<pre><code> const parseToYearAndMonth=(str)=&gt;{
  const date=str?new Date(str):new Date()
  return {
    year:date.getFullYear(),
    month:date.getMonth()+1
  }
}</code></pre><p>2.判断是否是有效的日期：</p>
<pre><code>const isValidDate=(dateString)=&gt;{
  const regEx= /^\d{4}-\d{2}-\d{2}$/;
  //如2019-01-01的格式
  if(!dateString.match(regEx))return false;
  const d=new Date(dateString);
  //getTime()返回距 1970 年 1 月 1 日之间的毫秒数：
  if(Number.isNaN(d.getTime()))return false;
  //toISOString使用 ISO 标准返回 Date 对象的字符串格式:
  return d.toISOString().slice(0,10)===dateString

}</code></pre><p>3.日期选择器的月份和年份：</p>
<pre><code> //生成一组连续数字的数组
 const range=(size,startAt=0)=&gt;{
  let arr=[]
  for(let i=0;i&lt;size;i++){
    arr[i]=startAt+i
  }
  return arr
}
//arr是1到12的数组，月份
 const monthRange=range(12,1)
 //arr是-4到4的数组，year是传入的年份，若为2019则年份选择器的年份为2015-2023
 const yearRange=range(9,-4).map(number=&gt;number+year)</code></pre><p>4.日期选择器样式代码：</p>
<pre><code>&lt;button className=&quot;btn btn-lg btn-secondary dropdown-toggle&quot;
          onClick={this.toggleDrodowm}&gt;
          {`${year}年${padLeft(month)}月`}
&lt;/button&gt;
        {isOpen &amp;&amp;
          &lt;div className=&quot;dropdown-menu&quot; style={{ display: 'block' ,width:'300px'}}&gt;
            &lt;div className=&#39;row&#39;&gt;
              &lt;div className=&#39;col border-right&#39;&gt;
               {yearRange.map((yearNumber,index)=&gt;
                &lt;a 
                key={index}
                className={yearNumber===selectedYear?&#39;dropdown-item active&#39;:&#39;dropdown-item&#39;}
                href=&#39;#&#39;
                onClick={(event)=&gt;{
                  this.selectedYear(event,yearNumber)
                }}
                &gt;
                {yearNumber}年
                &lt;/a&gt;
                )}
              &lt;/div&gt;
              &lt;div className=&#39;col months-range&#39;&gt;
              {monthRange.map((monthNumber,index)=&gt;
                &lt;a 
                key={index}
                className={monthNumber==month?&#39;dropdown-item active&#39;:&#39;dropdown-item&#39;}
                href=&#39;#&#39;
                onClick={(event)=&gt;{
                  this.selectedMonth(event,monthNumber)
                }}
                &gt;
                {padLeft(monthNumber)}月
                &lt;/a&gt;)
                }</code></pre><p>5.关于日期选择器，点击按钮和除日期选择器其他地方，日期选择器消失的实现：</p>
<pre><code> componentDidMount(){
    document.addEventListener(&#39;click&#39;,this.handleClick,false)
    //监听点击事件，一有监听到，执行回调函数handleClick
    }
    //组件关闭时清除事件监听
    componentWillUnmount(){
    document.removeEventListener(&#39;click&#39;,this.handleClick,false)
  }
   handleClick=(event)=&gt;{
    if(this.node.contains(event.target)){
      return
    }
    //this.node为绑定ref处
    this.setState({
      isOpen:false
     })
  }
  ....
  render(){
  return(
    &lt;div className=&quot;dropdown month-picker-component&quot;  ref={(ref)=&gt;{this.node=ref}}&gt;
    ....
    &lt;/div&gt;
  )
  }</code></pre><h2 id="四-数据处理"><a href="#四-数据处理" class="headerlink" title="四.数据处理"></a>四.数据处理</h2><p>1.对于数据一对多的处理，参考数据库处理，采用外键</p>
<pre><code>const items=[{
  id:1,
  title:&#39;去云南旅游&#39;,
  date:&#39;2019-01-01&#39;,
  price:2100,
  cid:1
},
{
  id:2,
  date:&#39;2019-01-12&#39;,
  title:&#39;去泰国旅游&#39;,
  price:3200,
  cid:1
},
{
  id:3,
  date:&#39;2019-04-12&#39;,
  title:&#39;炒股&#39;,
  price:2200,
  cid:2
}]
const category=[
  {
    id:1,
    name:&#39;旅游&#39;,
    type:&#39;outcome&#39;,
    iconName:&#39;ios-plane&#39;
  },
  {
    id:2,
    name:&#39;理财&#39;,
    type:&#39;income&#39;,
    iconName:&#39;logo-yen&#39;
  }
]</code></pre><p>以cid为纽带连接两者：</p>
<pre><code>const itemsWithCategory=items.map(item=&gt;{
     item.category=category.filter(citem=&gt;citem.id===item.cid)[0]
     console.log(item)
     return item
   }).filter(item=&gt;{
     return item.date.includes(`${currentDate.year}-${padLeft(currentDate.month)}`)
   })
   //filter是过滤数据，此处是根据日期过滤，采用includes实现</code></pre><p>2.数据操作方法的简化：采用对象键值对替代数组，就可以采用object[id]直接得到值(Flatten State)</p>
<pre><code>//数据扁平化：
const flatternArr=(arr)=&gt;(
  arr.reduce((map,item)=&gt;{
    map[item.id]=item
    return map
  },{})
)</code></pre><p>对象的操作方法：在items中添加类别：</p>
<pre><code>const itemsWithCategory = Object.keys(items).map(id =&gt; {
    items[id].category = data.category[items[id].cid]
    return items[id]
  })
  //先取得对象的属性名数组，在添加类别</code></pre><h2 id="五-表单处理"><a href="#五-表单处理" class="headerlink" title="五.表单处理"></a>五.表单处理</h2><pre><code>&lt;form onSubmit={(event) =&gt; { this.submitForm(event) }} noValidate&gt;
&lt;div className=&quot;form-group&quot;&gt;
          &lt;label htmlFor=&quot;date&quot;&gt;日期 *&lt;/label&gt;
          {/*htmlFor:htmlFor 属性设置或返回 lable 的 for 属性的值。for 属性指定 label 要绑定到哪一个表单元素。*/}
          &lt;input
            type=&quot;date&quot; className=&quot;form-control&quot;
            id=&quot;date&quot; placeholder=&quot;请输入日期&quot;
            defaultValue={date}
            ref={(input) =&gt; { this.dateInput = input }}
          /&gt;
          {/*type规范输入框输入的内容，defaultValue指定默认值，用于编辑页面，ref把值绑定该节点，可以传输给提交*/}
        &lt;/div&gt;
        &lt;button type=&quot;submit&quot; className=&#39;btn btn-primary mr-3&#39;&gt;提交&lt;/button&gt;
        {/*用type绑定submit*/}
        &lt;button className=&quot;btn btn-secondary&quot; onClick={this.props.onCancelSubmit}&gt; 取消 &lt;/button&gt;
        {/*错误信息提示*/}
        {!this.state.validatePass &amp;&amp;
          &lt;div className=&#39;alert alert-danger mt-5&#39; role=&quot;alert&quot;&gt;
            {this.state.errorMessage}
          &lt;/div&gt;}
      &lt;/form&gt;
</code></pre><p>提交函数的处理：</p>
<pre><code>const {item,onFormSubmit}=this.props
    const editMode=!!item.id
    //如果是编辑，item.id存在，editMode为true,否则为false
    const price=this.priceInput.value.trim()*1
    const date=this.this.dateInput.value.trim()
    const title=this.titleInput.value.trim()
    //去除字符串的前后空格，price转化为数字
    if(price &amp;&amp; date &amp;&amp; title){
      if (price &lt; 0) {
        this.setState({
          validatePass: false,
          errorMessage: &#39;价格数字必须大于0&#39;
        })     
      } else if (!isValidDate(date)) {
        this.setState({
          validatePass: false,
          errorMessage: &#39;请填写正确的日期格式&#39;
        })
      }else{
        this.setState({
          validatePass: true,
          errorMessage: &#39;&#39;
        })
        if(editMode){
          // 如果是编辑就用所填内容替代item
          onFormSubmit({...item,title,price,date},editMode)
        }else{
          onFormSubmit({ title, price, date }, editMode)
        }
      }  
    }else {
      this.setState({
        validatePass: false,
        errorMessage: &#39;请输入所有必选项&#39;
      })
    }
    event.preventDefault()

  }</code></pre><p>新增项目和编辑项目是同个组件不同路由，编辑会携带项目id区分：</p>
<p>编辑的路由设置：</p>
<pre><code>&lt;Route path=&#39;/edit/:id&#39;component={Create}/&gt;

//获取参数
cosnt Create=({match})=&gt;{

return &lt;h1&gt;this is the create page{match.params.id}&lt;/h1&gt;

}</code></pre><h2 id="六-context"><a href="#六-context" class="headerlink" title="六.context"></a>六.context</h2><p>提供者：</p>
<pre><code>//App.js
&lt;AppContext.Provider value={{
      state:this.state,
      actions:this.actions
    }}&gt;
    。。。。
    &lt;/AppContext.Provider&gt;
</code></pre><p>消费者：可以把消费的封装：</p>
<pre><code>import React from &#39;react&#39;
import{AppContext}from&#39;./App&#39;
const WithContext=(Component)=&gt;{
  return(props)=&gt;(
    &lt;AppContext.Consumer&gt;
      {({state,actions})=&gt;(
        &lt;Component {...props} data={state} actions={actions}/&gt;
      )}
    &lt;/AppContext.Consumer&gt;
  )
}
export default WithContext</code></pre><p>组件引用：</p>
<pre><code>import WithContext from &#39;../withContext&#39;
class Home extends Component{
render() {
    const {data}=this.props
    console.log(&#39;dtata&#39;,data)
    }
    return(
    &lt;p&gt;{data}&lt;/p&gt;
    )
}
export default WithContext(Home)</code></pre><h2 id="七-关于分类图标选中问题"><a href="#七-关于分类图标选中问题" class="headerlink" title="七.关于分类图标选中问题"></a>七.关于分类图标选中问题</h2><p>选中图标，图标高亮，其他图标灰色</p>
<pre><code> &lt;div className=&quot;row&quot;&gt;
         {categories.map((category,index)=&gt;{
           const iconColor=(category.id===selectedCategoryId)?Colors.white:Colors.gray
           const backColor = (category.id === selectedCategoryId) ? Colors.blue : Colors.lightGray
           const activeClassName = (selectedCategoryId === category.id)?&#39;category-item col-3 active&#39; : &#39;category-item col-3&#39;
           return(
             &lt;div className={activeClassName} key={index} role=&quot;button&quot; style={{ textAlign: 'center'}}
             onClick={(event)=&gt;{this.selectCategory(event, category)}}
             &gt;
               &lt;Ionicon
                  className=&quot;rounded-circle&quot;
                  style={{ backgroundColor: backColor, padding: '5px' }} 
                  fontSize=&quot;50px&quot;
                  color={iconColor}
                  icon={category.iconName}
                /&gt;
                 &lt;p&gt;{category.name}&lt;/p&gt;

               &lt;/div&gt;
           )
         })}
        &lt;/div&gt;
</code></pre><h2 id="八-Tabs标签（高复用性，利用child实现）"><a href="#八-Tabs标签（高复用性，利用child实现）" class="headerlink" title="八.Tabs标签（高复用性，利用child实现）"></a>八.Tabs标签（高复用性，利用child实现）</h2><pre><code>export class Tabs extends React.Component {
  constructor(props) {
    super(props)
    this.state = {
      activeIndex: props.activeIndex
    }
  }
  tabChange = (event, index) =&gt; {
    event.preventDefault()
    this.setState({
      activeIndex: index
    })
    this.props.onTabChange(index)
  }
  render() {
    const { children } = this.props
    const { activeIndex } = this.state
    return (
      &lt;ul className=&quot;nav nav-tabs nav-fill my-4&quot;&gt;
        {React.Children.map(children, (child, index) =&gt; {
          const activeClassName = (activeIndex === index) ? &#39;nav-link active&#39; : &#39;nav-link&#39;
          return (
            &lt;li className=&#39;nav-item&#39;&gt;
              &lt;a
                onClick={(event) =&gt; { this.tabChange(event, index) }}
                className={activeClassName}
                role=&quot;button&quot;
              &gt;
                {child}
              &lt;/a&gt;
            &lt;/li&gt;
          )
        })}

      &lt;/ul&gt;
    )
  }
}
Tabs.propTypes = {
  activeIndex: PropTypes.number.isRequired,
  onTabChange: PropTypes.func.isRequired,
}
export const Tab = ({ children }) =&gt; 
&lt;React.Fragment&gt;{children}&lt;/React.Fragment&gt;</code></pre><pre><code>//使用
const tabsText = [TYPE_OUTCOME, TYPE_INCOME]
const tabIndex = tabsText.findIndex(text =&gt; text === selectedTab)
 tabChange = (index) =&gt; {
    this.setState({
      selectedTab: tabsText[index]
    })
  }
 &lt;Tabs activeIndex={tabIndex} onTabChange={this.tabChange}&gt;
          &lt;Tab&gt;支出&lt;/Tab&gt;
          &lt;Tab&gt;收入&lt;/Tab&gt;
        &lt;/Tabs&gt;</code></pre><h2 id="九-基础增删改"><a href="#九-基础增删改" class="headerlink" title="九.基础增删改"></a>九.基础增删改</h2><p>1.添加一个新项目</p>
<pre><code>const newItem={
  id:items.length+1,
  date:&#39;2019-01-01&#39;,
  title:&#39;新添加的项目&#39;,
  price:100,
  cid:1

}
 createItem=()=&gt;{
   this.setState({
     items:[newItem,...this.state.items]
   })
  }</code></pre><p>2.删除一个项目（采用filter）</p>
<pre><code> deleteItem=(deletedItem)=&gt;{
    const filteredItems=this.state.items.filter(item=&gt;item.id!==deletedItem.id)
    this.setState({
      items:filteredItems
    })

  }</code></pre><p>3.编辑一个项目</p>
<pre><code>ModifyItem=(modifyItem)=&gt;{
  const modifyItems=this.state.items.map(item=&gt;{
    if(item.id===modifyItem.id){
      return{...item,title:&#39;更新后的标题&#39;}
      //此处应改为跳转到对应页面
    }else{
      return item
    }
  })
  this.setState({
    items:modifyItems
  })
  }</code></pre><h2 id="十-数据扁平化后优化增删改"><a href="#十-数据扁平化后优化增删改" class="headerlink" title="十.数据扁平化后优化增删改"></a>十.数据扁平化后优化增删改</h2><p>采用App context提供action</p>
<p>1.action</p>
<pre><code>this.actions={
      deleteItem:(item)=&gt;{
        delete this.state.items[item.id]
        //对象删除的方法
        // console.log(&#39;删除后&#39;,this.state.items))
        this.setState({
          items:this.state.items
        })
      },
      createItem:(data,categoryId)=&gt;{

        const newId=ID()
        const parsedDate=parseToYearAndMonth(data.date)
        //添加data未填写自动生成的数据
        data.monthCategory=`${ parsedDate.year}-${ parsedDate.month}`
        data.timestamp=new Date(data.date).getTime()
        const newItem={...data,id:newId,cid:categoryId}
        this.setState({
          items:{...this.state.items,[newId]:newItem}
          //items对象中新增item:[newId]:newItem
        })
      },
      updateItem:(item,updatedCategoryId)=&gt;{
        const modifedItem={
          ...item,
          cid:updatedCategoryId,
          timestamp:new Date(item.date).getTime()
        }
        this.setState({
          items:{...this.state.items,[modifedItem.id]:modifedItem}
        })
      }
    }
  }</code></pre><p>2.编辑与新增的按钮方法</p>
<pre><code>//编辑，传入id
ModifyItem=(modifyItem)=&gt;{
this.props.history.push(`/edit/${modifyItem.id}`)
  }
  //新增
 createItem=()=&gt;{
  this.props.history.push(&#39;/create&#39;)
  }  </code></pre><p>3.把数据传入表格：</p>
<pre><code>//得到编辑项的类别
 this.state={
 selectedCategory:  (id&amp;&amp;items[id])?category[items[id].cid]:null}
 //id可以拿到编辑项原来的数据，若id不存在即是新增
const {id}=this.props.match.params
    const editItem=(id&amp;&amp;items[id])?items[id]:{}&lt;PriceForm 
          onFormSubmit={this.submitForm}
          onCancelSubmit={this.cancelSubmit}
          item={editItem}
        /&gt;
        //组件需要绑定withRouter
        export default withRouter(WithContext(Create))</code></pre><p>4.组件表格使用action</p>
<pre><code> //提交，根据isEditMode判断是编辑还是新增
submitForm=(data,isEditMode)=&gt;{
    if(!isEditMode){

     //新增，传入数据和选中的类别this.props.actions.createItem(data,this.state.selectedCategory.id)
    }else{
      this.props.actions.updateItem(data,this.state.selectedCategory.id)
    }
    //回到首页
    this.props.history.push(&#39;/&#39;)
  }
  //如果是编辑，则传入的item有值，使用defaultValue={title}写入默认值
  &lt;input
            type=&#39;text&#39;
            className=&#39;form-control&#39;
            id=&#39;title&#39;
            placeholder=&#39;请输入标题&#39;
            defaultValue={title}
            ref={(input) =&gt; { this.titleInput = input }}
          /&gt;</code></pre><p>5.其中随机id的生成</p>
<pre><code>export const ID = () =&gt; {
  // Math.random should be unique because of its seeding algorithm.
  // Convert it to base 36 (numbers + letters), and grab the first 9 characters
  // after the decimal.
  return &#39;_&#39; + Math.random().toString(36).substr(2, 9);
}</code></pre><h2 id="十一-与后端交互–准备"><a href="#十一-与后端交互–准备" class="headerlink" title="十一.与后端交互–准备"></a>十一.与后端交互–准备</h2><p>1.数据模拟：采用json-server，不仅可以模拟数据，还可以模拟方法（增删改查）</p>
<p>安装：</p>
<pre><code>cnpm i --save json-server</code></pre><p>配置（package.json):</p>
<pre><code>&quot;scripts&quot;: { 

&quot;mock&quot;: &quot;json-server --watch db.json --port 3004&quot;
}</code></pre><p>数据文件db.json(在根目录):</p>
<pre><code>db.json:

{

  &quot;categories&quot;: [

    {

      &quot;name&quot;: &quot;旅行&quot;,

     &quot;iconName&quot;: &quot;ios-plane&quot;,

      &quot;id&quot;: &quot;1&quot;,

      &quot;type&quot;: &quot;outcome&quot;

    },

]}</code></pre><p>运行：</p>
<pre><code>npm run mock</code></pre><p>2.交互请求的方式：</p>
<p>get:读</p>
<p>post:写</p>
<p>delete:删除</p>
<p>put和patch:更新，其中put是把请求的数据全部替换原有数据，而patch仅更新请求的数据</p>
<p>筛选与排序：/items?monthCategory=2018-8&amp;_sort=timeStamp -GET</p>
<p>3.使用postman测试API接口</p>
<p>4.concurrently：将多个命令（如mock和start结合成一个命令）</p>
<p>因为mock和start都默认端口3000,则同时运行npm mock和npm start会报错，所以需要把mock修改端口：</p>
<pre><code> &quot;mock&quot;: &quot;json-server --watch db.json --port 3004&quot;</code></pre><p>然后将两个命令结合成一个命令：npm start</p>
<p>安装concurrently：</p>
<pre><code>npm i concurrently --save-dev</code></pre><p>修改配置：</p>
<pre><code>&quot;start&quot;: &quot;concurrently \&quot;react-scripts start\&quot; \&quot;npm run mock\&quot;&quot;</code></pre><p>5.跨域处理（create-react-app）：</p>
<p>在package.json中添加：</p>
<pre><code>&quot;proxy&quot;:&quot;http://localhost:3004&quot;</code></pre><h2 id="十二-发起请求"><a href="#十二-发起请求" class="headerlink" title="十二.发起请求"></a>十二.发起请求</h2><pre><code>//actions
//async异步转同步，包裹一个promise对象
 getInitalData:async ()=&gt;{
        this.setState({
          isLoading:true
        })
        const {currentDate}=this.state
        const getURLWithData=`/items?monthCategory=${currentDate.year}-${currentDate.month}&amp;_sort=timestamp&amp;_order=desc`
        // const promiseArr=[axios.get(&#39;/categories&#39;),axios.get(getURLWithData)]
        // Promise.all(promiseArr).then(arr=&gt;{
        //   const [categories,items]=arr
        //   this.setState({
        //     items:flatternArr(items.data),
        //     category:flatternArr(categories.data),
        //     isLoading:false
        //   })
        // })
        //await:等待请求完成才可以接下去处理
        const results=await  Promise.all([axios.get(&#39;/categories&#39;),axios.get(getURLWithData)])

          const [categories,items]=results
          this.setState({
            items:flatternArr(items.data),
            category:flatternArr(categories.data),
            isLoading:false
          })
          //需要返回数据
          return items

      },
      //多个请求promise
      //单个请求直接用axios
        deleteItem: async (item)=&gt;{
        // axios.delete(`/items/${item.id}`).then(()=&gt;{
        //   delete this.state.items[item.id]
        // // console.log(&#39;删除后&#39;,this.state.items))
        // this.setState({
        //   items:this.state.items
        // })
        // })
        const deleteItem=await axios.delete(`/items/${item.id}`)

          delete this.state.items[item.id]
          this.setState({
            items:this.state.items
          })
       return deleteItem

      },
      //使用数据
      //home
       componentDidMount(){
    this.props.actions.getInitalData().then(items=&gt;{
      console.log(&#39;haha&#39;,items)
    })

  }
  //在this.props.data中就可以使用得到的数据了</code></pre><h2 id="十三-添加loading"><a href="#十三-添加loading" class="headerlink" title="十三.添加loading"></a>十三.添加loading</h2><p>在数据未加载成功前，可以以loading代替数据</p>
<p>1.样式</p>
<pre><code>const Loader=()=&gt;(
  &lt;div className=&#39;loading-component text-center&#39;&gt;
    &lt;Ionicon 
    icon=&#39;ios-refresh&#39;
    fontSize=&#39;40px&#39;
    color=&quot;#347eff&quot;
    rotate={true}//是否自动旋转
    /&gt;
    &lt;h5&gt;加载中&lt;/h5&gt;
  &lt;/div&gt;
)</code></pre><p>2.当没数据时显示：</p>
<pre><code> {isLoading&amp;&amp; &lt;Loader/&gt;}
          {
            !isLoading &amp;&amp; 数据}</code></pre><p>拿到数据时loading为false:</p>
<pre><code> getInitalData:async ()=&gt;{
        this.setState({
          isLoading:true
        })
     //拿数据省略
          this.setState({
            items:flatternArr(items.data),
            category:flatternArr(categories.data),
            isLoading:false
          })
          return items

      },</code></pre><p>3.将loading作为公共函数添加到每个action</p>
<pre><code>const withLoading=(cb)=&gt;{
      return (...args)=&gt;{//得到参数
      this.setState({
        isLoading:true
      })
      return cb(...args)//执行参数
    }
    }
</code></pre><p>添加：</p>
<pre><code> getEditData:withLoading(async(id)=&gt;{
        let promiseArr=[axios.get(&#39;/categories&#39;)]
        if(id){
          const getURLWithID=`/items/${id}`
          promiseArr.push(axios.get(getURLWithID))
        }
        const [categories,editItem]=await Promise.all(promiseArr)
        if(id){
          this.setState({
            category:flatternArr(categories.data),
            isLoading:false,
            items:{...this.state.items,[id]:editItem.data}
          })
        }else{
          this.setState({
            category:flatternArr(categories.data),
            isLoading:false,

          })
        }
        return {
          categories:flatternArr(categories.data),
          editItem:editItem?editItem.data:null
        }
      }),</code></pre><h2 id="十四-优化请求"><a href="#十四-优化请求" class="headerlink" title="十四.优化请求"></a>十四.优化请求</h2><p>让已加载的数据不再加载</p>
<pre><code>getEditData:withLoading(async(id)=&gt;{
        const {items,category}=this.state
        let promiseArr=[]
        if(Object.keys(category).length===0){
          promiseArr.push(axios.get(&#39;/categories&#39;))
        }
        const itemIdISexit=(Object.keys(items).indexOf(id)&gt;-1)//判断该id是否被加载过
        if(id &amp;&amp; !itemIdISexit){//第一次加载
          const getURLWithID=`/items/${id}`
          promiseArr.push(axios.get(getURLWithID))
        }
        const [categories,editItem]=await Promise.all(promiseArr)
        const finalCategories=categories?flatternArr(categories.data):category
        //如果不是第一次加载，就直接用原先的categories，若是第一次就处理得到的数据
        const finalItem=editItem?editItem.data:items[id]
        if(id){
          this.setState({
            category:finalCategories,
            isLoading:false,
            items:{...this.state.items,[id]:finalItem}
          })
        }else{
          this.setState({
            category:flatternArr(categories.data),
            isLoading:false,

          })
        }
        return {
          categories:finalCategories,
          editItem:finalItem
        }
      }),</code></pre><h2 id="十五-模拟生产环境"><a href="#十五-模拟生产环境" class="headerlink" title="十五.模拟生产环境"></a>十五.模拟生产环境</h2><p>express(本机的部署)</p>
<p>build项目：</p>
<pre><code>npm build</code></pre><p>根目录文件：server.js</p>
<p>需要部署的资源分为静态文件（如css,html等）和API(增删改查方法等)</p>
<pre><code>const jsonServer=require(&#39;json-server&#39;)
const express=require(&#39;express&#39;)
const server = jsonServer.create()
const router=jsonServer.router(&#39;db.json&#39;)
const path=require(&#39;path&#39;)
const middlewares=jsonServer.defaults()
//中间件，可以在request和response之间做一系列的操作
const port =process.env.LEANCLOUD_APP_PORT||3000//lean cloud的端口
const root =__dirname+&#39;/build&#39;
//静态资源
server.use(express.static(root,{maxAge:8640000}))//过期时间
const reactRouterWhiteList=[&#39;/create&#39;,&#39;/edit/:itemId&#39;]//白名单
server.get(reactRouterWhiteList,(requst,response)=&gt;{
  response.sendFile(path.resolve(root,&#39;index.html&#39;))
})
//新增或编辑当前两个页面刷新不跳转
server.use(router)
server.use(middlewares)
server.listen(3000,()=&gt;{
  console.log(&#39;running&#39;)
})
//router和middlewares处理api</code></pre><h2 id="十六-线上部署"><a href="#十六-线上部署" class="headerlink" title="十六.线上部署"></a>十六.线上部署</h2><p>云平台的部署：</p>
<p>leanCloud:云引擎和云缓存</p>

  </article>
  
    
<div class="nexmoe-post-copyright">
<i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
<strong>Author：</strong>shuo<br>
<strong>Link：</strong><a href="http://yoursite.com/2019/10/08/记账本笔记整理/" title="http://yoursite.com/2019/10/08/记账本笔记整理/" target="_blank" rel="noopener">http://yoursite.com/2019/10/08/记账本笔记整理/</a><br>

  <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

</div>


  
  <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '80b2453b6d5f37ad6225',
        clientSecret: '43e99fa852795c9a7b3eb924b2558c64b84bbdeb',
        id: window.location.pathname,
        repo: 'nexmoe.github.io',
        owner: 'nexmoe',
        admin: 'nexmoe'
    })
    gitalk.render('gitalk')
</script>
</section>
</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
 
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


 
    <script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.9/SmoothScroll.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="../../../../js/app.js?v=1572060641383"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>

  





</body>

</html>
